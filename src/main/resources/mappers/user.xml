<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="UserDAO">
	<!-- 로그인 -->
	<select id="selectMember" parameterType="String" resultMap="memberMap">
		select userid,
				userpw,
				enabled
		from user_member_tbl
		where userid = #{userid}
	</select>
	<resultMap type="java.util.Map" id="memberMap">
		<id property="username" column="userid"/>
		<result property="password" column="userpw"/>
		<result property="enabled" column="enabled"/>
		<association property="authority" column="userid" select="getAuthority"/>
	</resultMap>
	<select id="getAuthority" resultType="com.team.smart.security.config.UserGrantedAuthority">
		 SELECT a.comp_auth
                , a.comp_seq
                , o.comp_org
                , a.b_code
                , b.b_name
                , b.b_status
                , c.r_code
                , c.rt_date1
                , c.rt_date2
		 FROM user_compauth_tbl a
         LEFT JOIN 
         room_contract_tbl c
         ON a.rt_code = c.rt_code
         LEFT JOIN
         building_tbl b
         ON a.b_code = b.b_code
         LEFT JOIN user_company_tbl o
         ON a.comp_seq = o.comp_seq 
		 WHERE a.userid = #{userid}
	</select>
	<!-- 로그인 -->
	
	<!-- 회원가입(회원등록) -->
	<insert id="insertUser" parameterType="com.team.smart.vo.UserVO">
		insert into user_member_tbl(userid, userpw, name, email, hp) 
    	values(#{userid}, #{userpw}, #{name}, #{email}, #{hp})
	</insert>
	
	<!-- 업체등록 -->
	<insert id="insertComp" parameterType="com.team.smart.vo.CompVO">
		insert into user_company_tbl(comp_seq, comp_section, comp_org, comp_bn, comp_owner, comp_branch, comp_master, comp_business, comp_category, comp_hp, comp_status)  
		values(#{comp_seq}, #{comp_section}, #{comp_org}, #{comp_bn}, #{comp_owner}, #{comp_branch}, #{comp_master}, #{comp_business}, #{comp_category}, #{comp_hp}, #{comp_status})
	</insert>
	
	<!-- 권한등록(업체등록에따른) -->
	<insert id="insertAuth" parameterType="java.util.Map">
		insert into user_compauth_tbl(userid, comp_auth, rt_code, comp_seq, b_code) values(#{userid}, #{comp_auth}, #{rt_code, jdbcType=VARCHAR}, #{comp_seq, jdbcType=VARCHAR}, #{b_code, jdbcType=VARCHAR})
	</insert>
	
	<insert id="insertBd" parameterType="com.team.smart.vo.BuildingVO">
		insert into building_tbl(b_code, b_area1, b_area2, b_address, b_name, b_floor, b_year, b_park, b_elev, b_heat, b_traffic, b_lat, b_lon, userid)
		VALUES(#{b_code}, #{b_area1}, #{b_area2}, #{b_address}, #{b_name}, #{b_floor}, #{b_year}, #{b_park}, #{b_elev}, #{b_heat}, #{b_traffic}, #{b_lat}, #{b_lon}, #{userid})
	</insert>
	
</mapper>